name: Deploy LuftControl

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Baixar código (Runner)
      uses: actions/checkout@v4

    - name: Atualizar Aplicação no Servidor
      shell: powershell
      env:
        COMMIT_MSG: ${{ github.event.head_commit.message }}
        COMMIT_AUTHOR: ${{ github.actor }}
        PYTHONUTF8: "1"
        PYTHONIOENCODING: "utf-8"
      run: |
        # --- CONFIGURAÇÕES ---
        $ServiceName = "LuftControl"
        $AppPath = "C:\ProjetosPython\LuftControl"
        $LogFile = "C:\actions-runner-luftControl\deploy-log.txt"
        $NssmExe = "C:\nssm-2.24\win64\nssm.exe"
        
        # Inicia Log
        Start-Transcript -Path $LogFile -Append
        Write-Host "--- DEPLOY INICIADO: $(Get-Date) por $env:COMMIT_AUTHOR ---"
        Write-Host "Msg: $env:COMMIT_MSG"
        $ErrorActionPreference = "Stop"

        # -----------------------------------------------------------
        # 1. PARAR SERVIÇO
        # -----------------------------------------------------------
        Write-Host "1. Verificando serviço $ServiceName..."
        if (Get-Service $ServiceName -ErrorAction SilentlyContinue) {
            Write-Host "Parando serviço..."
            cmd /c "$NssmExe stop $ServiceName" 2>&1 | Out-Null
            Start-Sleep -Seconds 3
        }

        # -----------------------------------------------------------
        # 2. ATUALIZAR ARQUIVOS (COPIAR DO RUNNER -> PASTA DE DESTINO)
        # -----------------------------------------------------------
        Write-Host "2. Copiando arquivos para $AppPath..."
        
        # Cria a pasta de destino se não existir
        if (-not (Test-Path $AppPath)) { 
            New-Item -Path $AppPath -ItemType Directory -Force 
        }

        # Copia os arquivos baixados pelo checkout para a pasta de produção
        # Excluímos .git (não precisa no servidor) e .venv (para não quebrar o ambiente virtual local)
        Copy-Item -Path ".\*" -Destination $AppPath -Recurse -Force -Exclude ".git",".venv"
        
        Write-Host "Arquivos copiados com sucesso."

        # -----------------------------------------------------------
        # 3. ATUALIZAR DEPENDÊNCIAS
        # -----------------------------------------------------------
        Write-Host "3. Verificando dependências..."
        
        # Entra na pasta do projeto
        Set-Location $AppPath

        if (Test-Path ".venv") {
            cmd /c ".venv\Scripts\python.exe -m pip install -r requirements.txt"
        } else {
            Write-Warning "Criando venv..."
            cmd /c "python -m venv .venv"
            cmd /c ".venv\Scripts\python.exe -m pip install -r requirements.txt"
        }

        # -----------------------------------------------------------
        # 4. INICIAR SERVIÇO
        # -----------------------------------------------------------
        Write-Host "4. Iniciando serviço $ServiceName..."
        cmd /c "$NssmExe start $ServiceName"
        Start-Sleep -Seconds 5
        
        $ServiceStatus = Get-Service $ServiceName
        if ($ServiceStatus.Status -eq 'Running') {
            Write-Host "SUCESSO: Serviço iniciado!"
        } else {
            Write-Error "FALHA: O serviço não subiu. Verifique o log do app."
            Stop-Transcript; exit 1
        }

        Write-Host "--- DEPLOY FINALIZADO ---"
        Stop-Transcript