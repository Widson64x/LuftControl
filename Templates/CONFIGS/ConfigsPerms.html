{% extends "Base.html" %}

{% block title %}Gerenciador de Segurança{% endblock %}

{% block extra_css %}
<style>
    /* --- Layout Principal --- */
    .sec-wrapper {
        display: grid;
        grid-template-columns: 260px 1fr;
        gap: var(--spacing-xl, 25px);
        height: calc(100vh - 140px);
        animation: fadeIn 0.4s ease-out;
    }

    /* --- Sidebar de Navegação --- */
    .sec-sidebar {
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        border-radius: var(--radius-lg, 12px);
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .nav-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 16px;
        color: var(--text-secondary);
        background: transparent;
        border: none;
        border-radius: var(--radius-md, 8px);
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: left;
        font-weight: 500;
        font-size: 0.95rem;
    }

    .nav-item:hover {
        background: var(--bg-hover);
        color: var(--text-primary);
        transform: translateX(4px);
    }

    .nav-item.active {
        background: linear-gradient(90deg, rgba(var(--primary-rgb), 0.15) 0%, transparent 100%);
        color: var(--primary);
        border-left: 3px solid var(--primary);
        border-radius: 4px 8px 8px 4px; /* Canto quadrado na esquerda */
    }

    /* --- Área de Conteúdo --- */
    .sec-content {
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        border-radius: var(--radius-lg, 12px);
        padding: 30px;
        overflow-y: auto;
        position: relative;
    }

    .tab-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border-secondary);
    }

    /* --- Lista de Usuários (Tabela Estilizada) --- */
    .user-list { display: flex; flex-direction: column; gap: 10px; }
    
    .user-card {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-secondary);
        border-radius: 8px;
        padding: 12px 20px;
        display: grid;
        grid-template-columns: 50px 2fr 1.5fr;
        align-items: center;
        transition: border-color 0.2s;
    }
    .user-card:hover { border-color: var(--primary); }

    .user-avatar {
        width: 36px; height: 36px;
        border-radius: 50%;
        background: var(--gradient-primary, linear-gradient(135deg, #667eea 0%, #764ba2 100%));
        color: white;
        display: flex; align-items: center; justify-content: center;
        font-weight: bold;
    }

    /* --- Cards de Grupos (Grid) --- */
    .roles-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
    }

    .role-card {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-secondary);
        border-radius: 10px;
        padding: 20px;
        position: relative;
        transition: transform 0.2s, box-shadow 0.2s;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 160px;
    }

    .role-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        border-color: var(--border-primary);
    }

    .role-actions {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid var(--border-secondary);
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    /* --- Checkboxes de Permissão (Grid Selecionável) --- */
    .perms-selection-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 10px;
        max-height: 400px;
        overflow-y: auto;
        padding: 5px;
    }

    .perm-check-item {
        position: relative;
        cursor: pointer;
    }

    .perm-check-item input {
        position: absolute; opacity: 0; cursor: pointer;
    }

    .perm-check-content {
        background: var(--bg-primary);
        border: 1px solid var(--border-secondary);
        padding: 10px 15px;
        border-radius: 6px;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
    }

    .perm-check-item input:checked ~ .perm-check-content {
        background: rgba(var(--primary-rgb), 0.1);
        border-color: var(--primary);
        color: var(--primary);
    }
    
    .perm-slug { font-family: monospace; font-size: 0.85rem; font-weight: 700; margin-bottom: 4px; }
    .perm-desc { font-size: 0.75rem; color: var(--text-secondary); }

    /* --- Listagem de Permissões (Simples) --- */
    .perm-row {
        display: flex; justify-content: space-between; align-items: center;
        padding: 10px 15px;
        border-bottom: 1px solid var(--border-secondary);
        background: var(--bg-tertiary);
    }
    .perm-row:first-child { border-top-left-radius: 8px; border-top-right-radius: 8px; }
    .perm-row:last-child { border-bottom: none; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; }

</style>
{% endblock %}

{% block content %}

<div class="page-header mb-4 fade-in">
    <div class="d-flex justify-between align-center">
        <div>
            <h1 class="page-title m-0"><i class="fas fa-shield-alt text-primary"></i> Central de Segurança</h1>
            <p class="text-secondary m-0 text-sm">Controle de Acesso Baseado em Papéis (RBAC)</p>
        </div>
        <a href="{{ url_for('SecurityConfig.VisualizarMapaSeguranca') }}" class="btn btn-outline-primary">
            <i class="fas fa-project-diagram me-2"></i> Visualizar Mapa
        </a>
    </div>
</div>

<div class="sec-wrapper fade-in delay-1">
    
    <aside class="sec-sidebar">
        <button class="nav-item active" onclick="manager.switchTab('tabUsers', this)">
            <i class="fas fa-users"></i> Usuários & Acessos
        </button>
        <button class="nav-item" onclick="manager.switchTab('tabRoles', this)">
            <i class="fas fa-user-tag"></i> Grupos (Roles)
        </button>
        <button class="nav-item" onclick="manager.switchTab('tabPerms', this)">
            <i class="fas fa-key"></i> Permissões (Dev)
        </button>
    </aside>

    <main class="sec-content">
        
        <section id="tabUsers" class="tab-pane">
            <header class="tab-header">
                <div>
                    <h3 class="m-0">Usuários Ativos</h3>
                    <small class="text-secondary">Associe usuários a grupos predefinidos.</small>
                </div>
                <div class="input-group" style="width: 280px;">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" id="searchUser" class="form-control" placeholder="Buscar usuário..." onkeyup="manager.filterUsers()">
                </div>
            </header>
            
            <div id="usersListContainer" class="user-list">
                <div class="text-center py-5"><div class="spinner"></div> Carregando...</div>
            </div>
        </section>

        <section id="tabRoles" class="tab-pane" style="display: none;">
            <header class="tab-header">
                <div>
                    <h3 class="m-0">Grupos de Acesso</h3>
                    <small class="text-secondary">Defina conjuntos de permissões.</small>
                </div>
                <button class="btn btn-primary" onclick="manager.openRoleModal()">
                    <i class="fas fa-plus me-2"></i> Novo Grupo
                </button>
            </header>

            <div id="rolesListContainer" class="roles-grid">
                </div>
        </section>

        <section id="tabPerms" class="tab-pane" style="display: none;">
            <header class="tab-header">
                <div>
                    <h3 class="m-0">Catálogo de Permissões</h3>
                    <small class="text-secondary">Slugs técnicos usados pelos desenvolvedores (Decorators).</small>
                </div>
                <button class="btn btn-secondary" onclick="manager.openPermModal()">
                    <i class="fas fa-plus me-2"></i> Criar Permissão
                </button>
            </header>

            <div class="mb-3">
                <input type="text" class="form-control" placeholder="Filtrar permissões..." onkeyup="manager.filterPermList(this.value)">
            </div>

            <div id="permsListContainer" class="d-flex flex-column">
                </div>
        </section>

    </main>
</div>

<div id="modalRole" class="modal-overlay">
    <div class="modal-container modal-lg">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-user-shield me-2"></i> Editor de Grupo</h3>
            <button class="modal-close" onclick="closeModals()"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <input type="hidden" id="roleId">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Nome do Grupo</label>
                    <input type="text" id="roleName" class="form-control" placeholder="Ex: Financeiro Manager">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Descrição</label>
                    <input type="text" id="roleDesc" class="form-control" placeholder="Breve resumo da função">
                </div>
            </div>
            
            <div class="mt-4 mb-2 d-flex justify-between align-end">
                <label class="form-label m-0">Permissões Associadas</label>
                <input type="text" class="form-control form-control-sm w-auto" placeholder="Filtrar..." onkeyup="manager.filterPermChecks(this.value)">
            </div>
            
            <div id="permissionsCheckGrid" class="perms-selection-grid bg-secondary border border-secondary rounded p-2">
                </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="closeModals()">Cancelar</button>
            <button class="btn btn-primary" onclick="manager.saveRole()">Salvar Alterações</button>
        </div>
    </div>
</div>

<div id="modalPerm" class="modal-overlay">
    <div class="modal-container modal-sm">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-key me-2"></i> Nova Permissão</h3>
            <button class="modal-close" onclick="closeModals()"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <div class="mb-3">
                <label class="form-label">Slug (Identificador Técnico)</label>
                <input type="text" id="newPermSlug" class="form-control font-monospace" placeholder="ex: relatorio.vendas.exportar">
                <div class="form-text text-xs">Use notação de ponto. Ex: modulo.acao</div>
            </div>
            <div class="mb-3">
                <label class="form-label">Descrição</label>
                <input type="text" id="newPermDesc" class="form-control" placeholder="Ex: Exportar CSV de vendas">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-ghost" onclick="closeModals()">Cancelar</button>
            <button class="btn btn-success" onclick="manager.createPermission()">Criar</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    const API = {
        getUsers: "{{ url_for('SecurityConfig.ObterUsuariosAtivos') }}",
        updateUserRole: "{{ url_for('SecurityConfig.AtualizarPapelUsuario') }}",
        getRoles: "{{ url_for('SecurityConfig.ObterPapeisEPermissoes') }}",
        saveRole: "{{ url_for('SecurityConfig.SalvarPapel') }}",
        deleteRole: "{{ url_for('SecurityConfig.ExcluirPapel') }}",
        savePerm: "{{ url_for('SecurityConfig.SalvarPermissao') }}",
        deletePerm: "{{ url_for('SecurityConfig.ExcluirPermissao') }}"
    };
</script>
<script src="{{ url_for('static', filename='JS/SecurityManager.js') }}"></script>
{% endblock %}