{% extends 'Base.html' %}

{% block title %}Configuração DRE | T-Controllership{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='CSS/Pages/ConfiguracaoDRE.css') }}">
    
    <style>
        /* --- VARIÁVEIS DE CORES --- */
        :root {
            --color-virtual: #f1c40f; /* Gold */
            --color-cc: #3498db;      /* Blue */
            --color-group: #e67e22;   /* Orange */
            --color-conta: #2ecc71;   /* Green */
            --bg-panel: #1A1F2E;
            --bg-hover: rgba(255,255,255,0.05);
            --border: rgba(255,255,255,0.1);
        }

        /* --- LAYOUT PRINCIPAL --- */
        .dre-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px);
            gap: 20px;
        }

        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-panel);
            padding: 15px 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            flex-wrap: wrap;
            gap: 10px;
        }

        /* --- BARRA DE FERRAMENTAS DE ORDENAMENTO --- */
        .ordenamento-toolbar {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: rgba(52, 152, 219, 0.1);
            border: 1px solid rgba(52, 152, 219, 0.3);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .ordenamento-toolbar.inactive {
            background: rgba(241, 196, 15, 0.1);
            border-color: rgba(241, 196, 15, 0.3);
        }

        .ordenamento-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-indicator.active {
            background: #2ecc71;
            box-shadow: 0 0 8px rgba(46, 204, 113, 0.6);
        }

        .status-indicator.inactive {
            background: #f39c12;
            box-shadow: 0 0 8px rgba(243, 156, 18, 0.6);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* --- ÁRVORE (TREE VIEW) --- */
        .tree-panel {
            flex: 1;
            background: var(--bg-panel);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow-y: auto;
            padding: 10px;
            position: relative;
        }

        ul.tree {
            list-style: none;
            padding-left: 20px;
            margin: 0;
        }
        
        ul.tree ul {
            border-left: 1px solid rgba(255,255,255,0.05);
            margin-left: 10px;
            padding-left: 15px;
            display: none;
        }
        
        ul.tree ul.expanded {
            display: block;
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        li {
            margin: 2px 0;
            position: relative;
        }

        /* --- NÓ (O ITEM CLICÁVEL) --- */
        .node-wrapper {
            display: flex;
            align-items: center;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.1s ease;
            user-select: none;
            border: 2px solid transparent;
        }

        .node-wrapper:hover {
            background-color: var(--bg-hover);
        }

        .node-wrapper.selected {
            background-color: rgba(52, 152, 219, 0.2);
            border-color: rgba(52, 152, 219, 0.4);
        }

        /* --- DRAG HANDLE --- */
        .drag-handle {
            opacity: 0;
            transition: opacity 0.2s;
            margin-right: 8px;
            color: #7f8c8d;
            cursor: grab;
            font-size: 0.8em;
        }

        .node-wrapper:hover .drag-handle {
            opacity: 0.5;
        }

        .node-wrapper[draggable="true"]:hover .drag-handle {
            opacity: 1;
        }

        .node-wrapper.dragging {
            opacity: 0.5;
            transform: scale(0.95);
            background: rgba(52, 152, 219, 0.2) !important;
            border: 2px dashed #3498db !important;
        }

        .node-wrapper.drop-target-valid {
            background: rgba(46, 204, 113, 0.15) !important;
            border: 2px solid #2ecc71 !important;
            box-shadow: 0 0 10px rgba(46, 204, 113, 0.3);
        }

        .node-wrapper.drop-target-invalid {
            background: rgba(231, 76, 60, 0.15) !important;
            border: 2px solid #e74c3c !important;
        }

        /* --- ÍCONES E TOGGLES --- */
        .toggle-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 5px;
            color: #7f8c8d;
            font-size: 0.7em;
            transition: transform 0.2s;
            border-radius: 4px;
        }
        
        .toggle-icon:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .toggle-icon.rotated { transform: rotate(90deg); color: #fff; }
        .toggle-icon.invisible { visibility: hidden; }

        .type-icon { margin-right: 8px; font-size: 1em; }

        /* --- BADGE DE ORDEM --- */
        .ordem-badge {
            margin-left: auto;
            padding: 2px 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            font-size: 0.7em;
            color: #95a5a6;
            font-family: monospace;
        }

        .ordem-badge:hover {
            background: rgba(52, 152, 219, 0.3);
            color: #3498db;
        }

        /* --- ESTILIZAÇÃO POR TIPO --- */
        .node-text { font-size: 0.9rem; color: #bdc3c7; }
        
        .node-folder .node-text { color: #ecf0f1; font-weight: 700; text-transform: uppercase; }
        .node-folder .type-icon { color: #f39c12; }

        .node-virtual .node-text { color: var(--color-virtual); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .node-virtual .type-icon { color: var(--color-virtual); }

        .node-cc .node-text { color: var(--color-cc); font-weight: 600; }
        .node-cc .type-icon { color: var(--color-cc); }

        .node-sg .node-text { color: var(--color-group); }
        .node-sg .type-icon { color: var(--color-group); }

        .node-conta .node-text { color: var(--color-conta); font-family: monospace; font-size: 0.85rem; }
        .node-conta .type-icon { color: var(--color-conta); font-size: 0.8em; opacity: 0.7; }

        /* --- DROP INDICATOR --- */
        .drop-indicator {
            display: none;
            position: fixed;
            z-index: 10000;
            pointer-events: none;
            transition: all 0.1s ease;
        }

        .drop-indicator .drop-line {
            height: 3px;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            border-radius: 3px;
            box-shadow: 0 0 8px rgba(52, 152, 219, 0.8);
        }

        .drop-indicator.position-inside {
            background: rgba(46, 204, 113, 0.1);
            border: 2px solid #2ecc71;
            border-radius: 6px;
        }

        /* --- MODAIS E OVERLAYS --- */
        .dre-modal-overlay { display: none; position: fixed !important; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .dre-modal-overlay.active { display: flex !important; }
        .dre-modal-box { background: #1e2736; border: 1px solid rgba(255,255,255,0.1); width: 500px; border-radius: 12px; padding: 25px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
        
        .custom-input { width: 100%; background: #131722; border: 1px solid #2c3e50; padding: 10px; color: #fff; border-radius: 6px; margin-top: 5px; }
        .custom-input:focus { border-color: #3498db; outline: none; }
        
        /* --- CSS DO GERENCIADOR EM MASSA (MODAL GRANDE) --- */
        .mass-modal-body { display: flex; height: 400px; background: #1e2736; border-radius: 8px; overflow: hidden; margin-top: 10px; border: 1px solid rgba(255,255,255,0.05); }
        .mass-sidebar { width: 180px; background: rgba(0,0,0,0.2); padding: 15px 0; border-right: 1px solid rgba(255,255,255,0.05); }
        .mass-nav-item { padding: 12px 20px; color: #95a5a6; cursor: pointer; transition: all 0.2s; font-size: 0.9rem; display: flex; align-items: center; gap: 10px; }
        .mass-nav-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .mass-nav-item.active { background: rgba(52, 152, 219, 0.1); color: #3498db; border-right: 3px solid #3498db; }
        .mass-content { flex: 1; padding: 25px; overflow-y: auto; }
        .mass-tab { display: none; }
        .mass-tab.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- CSS DO DASHBOARD INTERATIVO (Aba Vincular) --- */
        .mass-dashboard { display: flex; height: 320px; border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; background: rgba(0,0,0,0.2); }
        
        .col-groups { width: 35%; border-right: 1px solid rgba(255,255,255,0.1); overflow-y: auto; background: rgba(0,0,0,0.1); }
        .group-list-item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); color: #bdc3c7; transition: all 0.2s; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; }
        .group-list-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .group-list-item.active { background: rgba(52, 152, 219, 0.2); color: #3498db; border-left: 3px solid #3498db; }
        
        .col-accounts { flex: 1; padding: 15px; display: flex; flex-direction: column; }
        .accounts-header { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .linked-accounts-area { flex: 1; overflow-y: auto; margin-bottom: 15px; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 8px; }
        
        .account-tag { background: rgba(46, 204, 113, 0.15); border: 1px solid rgba(46, 204, 113, 0.3); color: #2ecc71; padding: 4px 10px; border-radius: 20px; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; }
        .account-tag .remove-btn { cursor: pointer; color: #e74c3c; font-size: 0.9em; padding: 2px; border-radius: 50%; }
        .account-tag .remove-btn:hover { background: rgba(231, 76, 60, 0.2); }
        .empty-state { color: #7f8c8d; font-size: 0.9rem; text-align: center; margin-top: 40px; width: 100%; }

        /* --- MENU DE CONTEXTO --- */
        #contextMenu {
            display: none; position: absolute; z-index: 10000;
            background: #2c3e50; border: 1px solid #34495e;
            border-radius: 8px; padding: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            min-width: 220px;
        }
        .ctx-item { padding: 8px 12px; cursor: pointer; color: #ecf0f1; font-size: 0.85rem; border-radius: 4px; display: flex; align-items: center; gap: 8px; }
        .ctx-item:hover { background: #34495e; color: #fff; }
        .ctx-item i { width: 16px; text-align: center; }
        .ctx-divider { height: 1px; background: #34495e; margin: 4px 0; }
        .ctx-badge { margin-left: auto; font-size: 0.7em; padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.1); }

        /* Toast */
        #toast { visibility: hidden; position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #27ae60; color: white; padding: 12px 24px; border-radius: 30px; font-weight: 600; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 10001; }
        #toast.show { visibility: visible; animation: slideUpFade 0.3s ease-out; }
        @keyframes slideUpFade { from { bottom: 0; opacity: 0; } to { bottom: 30px; opacity: 1; } }

        /* --- HELP TOOLTIP --- */
        .help-tooltip {
            position: relative;
            display: inline-flex;
            align-items: center;
            cursor: help;
        }

        .help-tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #2c3e50;
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            z-index: 1000;
        }

        .help-tooltip:hover::after {
            opacity: 1;
            visibility: visible;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container dre-container">
    
    <!-- HEADER COM AÇÕES -->
    <div class="header-actions">
        <div>
            <h2 class="text-xl font-bold text-primary mb-1"><i class="fas fa-layer-group"></i> Gerenciador DRE</h2>
            <p class="text-xs text-secondary mb-0">Estruture a visão financeira (Virtual) e departamental (Centros de Custo).</p>
        </div>
        <div class="d-flex gap-2 flex-wrap">
            <button class="btn btn-sm btn-outline-light" onclick="toggleAllTree(true)"><i class="fas fa-expand-alt"></i> Expandir</button>
            <button class="btn btn-sm btn-outline-light" onclick="toggleAllTree(false)"><i class="fas fa-compress-alt"></i> Recolher</button>
            <div class="vr mx-2" style="border-left: 1px solid #444;"></div>
            <button class="btn btn-warning btn-sm font-bold" onclick="openModal('modalAddVirtual')"><i class="fas fa-plus"></i> Raiz Virtual</button>
            <button class="btn btn-primary btn-sm" onclick="loadTree()"><i class="fas fa-sync-alt"></i> Atualizar</button>
        </div>
    </div>

    <!-- BARRA DE ORDENAMENTO -->
    <div class="ordenamento-toolbar" id="ordenamentoToolbar">
        <div class="ordenamento-status">
            <div class="status-indicator" id="ordenamentoIndicator"></div>
            <span id="ordenamentoStatusText">Verificando...</span>
        </div>
        
        <div style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
            <span class="help-tooltip" data-tooltip="Arraste os itens para reordenar. A ordem é salva automaticamente.">
                <i class="fas fa-question-circle text-secondary"></i>
            </span>
            
            <button class="btn btn-sm btn-outline-info" id="btnInicializarOrdem" onclick="inicializarOrdenamento()" style="display: none;">
                <i class="fas fa-magic"></i> Inicializar Ordenamento
            </button>
            
            <button class="btn btn-sm btn-outline-warning" id="btnResetarOrdem" onclick="resetarOrdenamento()" style="display: none;">
                <i class="fas fa-redo"></i> Resetar Ordem
            </button>
            
            <button class="btn btn-sm btn-outline-success" id="btnNormalizarOrdem" onclick="normalizarOrdenamento()" style="display: none;">
                <i class="fas fa-sort-numeric-down"></i> Normalizar
            </button>

            <button class="btn btn-sm btn-outline-light" onclick="sincronizarOrdem()" title="Busca itens novos no banco e adiciona à árvore">
                <i class="fas fa-sync"></i> Sincronizar
            </button>
        </div>
    </div>

    <!-- PAINEL DA ÁRVORE -->
    <div class="tree-panel" id="treeContainer">
        <ul id="treeRoot" class="tree">
            <li class="text-center text-secondary mt-5" style="opacity: 0.7;">
                <i class="fas fa-circle-notch fa-spin fa-2x mb-2"></i><br>Carregando estrutura...
            </li>
        </ul>
    </div>

</div>

<!-- TOAST -->
<div id="toast"><i class="fas fa-check"></i> Operação realizada!</div>

<!-- DROP INDICATOR -->
<div id="dropIndicator" class="drop-indicator">
    <div class="drop-line"></div>
</div>

<!-- MENU DE CONTEXTO -->
<div id="contextMenu">
    <div class="ctx-item" id="ctxRename" onclick="renameNode()">
        <i class="fas fa-edit text-warning"></i> Renomear
    </div>
    <div class="ctx-item" id="ctxMoveUp" onclick="moverParaCima()">
        <i class="fas fa-arrow-up text-info"></i> Mover para Cima
        <span class="ctx-badge">Alt+↑</span>
    </div>
    <div class="ctx-item" id="ctxMoveDown" onclick="moverParaBaixo()">
        <i class="fas fa-arrow-down text-info"></i> Mover para Baixo
        <span class="ctx-badge">Alt+↓</span>
    </div>
    <div class="ctx-divider" id="divOrdem"></div>
    
    <div class="ctx-item" id="ctxMassManager" onclick="openMassManager()">
        <i class="fas fa-tools text-warning"></i> Gerenciador em Massa
    </div>
    <div class="ctx-divider" id="divSystematic"></div>

    <div class="ctx-item" id="ctxAddSub" onclick="openModal('modalAddSub')"><i class="fas fa-folder-plus text-primary"></i> Criar Subgrupo</div>
    
    <div class="ctx-item" id="ctxCopy" onclick="copyNode()"><i class="fas fa-copy text-light"></i> Copiar Estrutura</div>
    <div class="ctx-item" id="ctxPaste" onclick="pasteNode()"><i class="fas fa-paste text-light"></i> Colar Aqui</div>
    <div class="ctx-divider" id="divCopy"></div>

    <div class="ctx-item" id="ctxLinkConta" onclick="openModal('modalLinkConta')"><i class="fas fa-link text-info"></i> Vincular Conta <span class="ctx-badge" style="background:#2980b9">CC</span></div>
    <div class="ctx-item" id="ctxLinkDetalhe" onclick="openModal('modalLinkDetalhe')"><i class="fas fa-tag text-success"></i> Vincular Conta <span class="ctx-badge" style="background:#27ae60">Virt</span></div>
    <div class="ctx-item" id="ctxReplicar" onclick="openReplicarModal()"><i class="fas fa-clone text-light"></i> Replicar em Massa...</div>
    
    <div class="ctx-divider" id="ctxDivider"></div>
    <div class="ctx-item" id="ctxDelete" onclick="deleteNode()" style="color:#e74c3c"><i class="fas fa-trash-alt"></i> <span id="lblDelete">Excluir</span></div>
</div>

<!-- MODAIS (mesmos do original) -->
<div id="modalMassManager" class="dre-modal-overlay">
    <div class="dre-modal-box" style="width: 750px; padding: 0;">
        <div class="d-flex justify-content-between align-items-center p-3 border-bottom border-secondary">
            <div>
                <h3 class="text-lg font-bold text-white mb-0">Gestão de Tipo: <span id="lblMassType" class="text-warning">...</span></h3>
                <p class="text-xs text-secondary mb-0">As ações aqui afetam TODOS os centros de custo deste tipo.</p>
            </div>
            <button class="btn btn-sm btn-outline-secondary" onclick="closeModals()">✕</button>
        </div>

        <div class="mass-modal-body">
            <div class="mass-sidebar">
                <div class="mass-nav-item active" onclick="switchMassTab('tabCreateGroup', this)">
                    <i class="fas fa-folder-plus"></i> Criar Grupo
                </div>
                <div class="mass-nav-item" onclick="switchMassTab('tabDeleteGroup', this)">
                    <i class="fas fa-folder-minus"></i> Excluir Grupo
                </div>
                <div class="mass-nav-item" onclick="switchMassTab('tabLinkAccount', this)">
                    <i class="fas fa-link"></i> Vincular Conta
                </div>
                <div class="mass-nav-item" onclick="switchMassTab('tabUnlinkAccount', this)">
                    <i class="fas fa-unlink"></i> Desvincular
                </div>
            </div>

            <div class="mass-content">
                <div id="tabCreateGroup" class="mass-tab active">
                    <h4 class="text-white font-bold mb-3">Criar Grupo em Massa</h4>
                    <p class="text-sm text-secondary mb-4">Cria uma nova pasta em todos os CCs do tipo selecionado.</p>
                    <label class="text-xs text-secondary uppercase font-bold">Nome do Novo Grupo</label>
                    <input type="text" id="inputMassCreateName" class="custom-input mb-4" placeholder="Ex: Despesas Gerais">
                    <button class="btn btn-warning w-100" onclick="submitMassCreate()">
                        <i class="fas fa-plus-circle"></i> Executar Criação
                    </button>
                </div>

                <div id="tabDeleteGroup" class="mass-tab">
                    <h4 class="text-white font-bold mb-3">Excluir Grupo em Massa</h4>
                    <p class="text-sm text-secondary mb-4">Remove a pasta e <span class="text-danger">tudo que estiver dentro dela</span> de todos os CCs.</p>
                    <label class="text-xs text-secondary uppercase font-bold">Selecione o Grupo para Excluir</label>
                    <select id="selectMassDeleteGroup" class="custom-input mb-4"></select>
                    <button class="btn btn-danger w-100" onclick="submitMassDelete()">
                        <i class="fas fa-trash-alt"></i> Executar Exclusão
                    </button>
                </div>

                <div id="tabLinkAccount" class="mass-tab">
                    <h4 class="text-white font-bold mb-2">Gerenciador de Vínculos</h4>
                    <p class="text-sm text-secondary mb-3">Selecione um grupo na esquerda para gerenciar suas contas.</p>
                    
                    <div class="mass-dashboard">
                        <div class="col-groups" id="listMassGroups">
                            <div class="text-center p-3 text-secondary">Carregando grupos...</div>
                        </div>

                        <div class="col-accounts">
                            <div id="noGroupSelected" class="h-100 d-flex flex-column align-items-center justify-content-center text-secondary">
                                <i class="fas fa-arrow-left fa-2x mb-3"></i>
                                <p>Selecione um grupo ao lado.</p>
                            </div>

                            <div id="groupDetails" style="display: none;" class="h-100 d-flex flex-column">
                                <div class="accounts-header d-flex justify-content-between align-items-center">
                                    <strong class="text-white" id="lblSelectedGroup">...</strong>
                                    <span class="badge bg-secondary" id="lblCountAccounts">0 contas</span>
                                </div>

                                <label class="text-xs text-secondary uppercase font-bold mb-2">Contas Vinculadas</label>
                                <div class="linked-accounts-area" id="listLinkedAccounts"></div>

                                <div class="add-account-area mt-auto">
                                    <label class="text-xs text-secondary uppercase font-bold">Adicionar Nova Conta</label>
                                    <div class="d-flex gap-2">
                                        <input type="text" id="inputMassLinkConta" list="massContasDataList" class="custom-input mt-0" placeholder="Busque a conta...">
                                        <button class="btn btn-info" onclick="addAccountToGroup()">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                                <datalist id="massContasDataList"></datalist>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tabUnlinkAccount" class="mass-tab">
                    <h4 class="text-white font-bold mb-3">Desvincular Conta em Massa</h4>
                    <p class="text-sm text-secondary mb-4">Remove o vínculo desta conta de todos os CCs deste tipo.</p>
                    <label class="text-xs text-secondary uppercase font-bold">Conta Contábil para Remover</label>
                    <input type="text" id="inputMassUnlinkConta" list="contasDataList" class="custom-input mb-4" placeholder="Digite a conta...">
                    <button class="btn btn-danger w-100" onclick="submitMassUnlink()">
                        <i class="fas fa-cut"></i> Executar Desvínculo
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modalAddVirtual" class="dre-modal-overlay">
    <div class="dre-modal-box">
        <h3 class="text-lg font-bold text-warning mb-3">Novo Nó Virtual (Raiz)</h3>
        <label class="text-xs text-secondary uppercase font-bold">Nome da Estrutura</label>
        <input type="text" id="inputVirtualName" class="custom-input" placeholder="Ex: RECEITA OPERACIONAL LÍQUIDA" autocomplete="off">
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeModals()">Cancelar</button>
            <button class="btn btn-warning" onclick="submitAddVirtual()">Criar</button>
        </div>
    </div>
</div>

<div id="modalAddSub" class="dre-modal-overlay">
    <div class="dre-modal-box">
        <h3 class="text-lg font-bold text-primary mb-3">Novo Subgrupo</h3>
        <p class="text-sm text-secondary mb-3">Dentro de: <strong id="lblParentName" class="text-white">...</strong></p>
        <label class="text-xs text-secondary uppercase font-bold">Nome do Grupo</label>
        <input type="text" id="inputSubName" class="custom-input" placeholder="Ex: Pessoal e Encargos" autocomplete="off">
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeModals()">Cancelar</button>
            <button class="btn btn-primary" onclick="submitAddSub()">Criar</button>
        </div>
    </div>
</div>

<div id="modalLinkConta" class="dre-modal-overlay">
    <div class="dre-modal-box" style="width: 600px;">
        <h3 class="text-lg font-bold text-primary mb-2">Gerenciar Contas do Grupo</h3>
        <p class="text-sm text-secondary mb-4">
            Grupo: <strong id="lblGroupTarget" class="text-white">...</strong>
        </p>

        <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-2 border-bottom border-secondary pb-1">
                <label class="text-xs text-secondary uppercase font-bold m-0">Contas Já Vinculadas</label>
                <span id="lblCountStd" class="badge bg-secondary text-xs">0</span>
            </div>
            
            <div id="listStdLinkedAccounts" class="linked-accounts-area" style="height: 120px; background: rgba(0,0,0,0.2); border-radius: 6px; padding: 10px; overflow-y: auto;"></div>
        </div>

        <div class="add-account-area">
            <label class="text-xs text-secondary uppercase font-bold">Adicionar Nova Conta</label>
            <div class="d-flex gap-2">
                <input type="text" id="inputContaSearch" list="stdContasDataList" class="custom-input mt-0" placeholder="Busque a conta disponível..." autocomplete="off">
                <button class="btn btn-primary" onclick="submitLinkConta()">
                    <i class="fas fa-plus"></i> Vincular
                </button>
            </div>
        </div>

        <div class="modal-actions mt-4 pt-3 border-top border-secondary justify-content-end">
            <button class="btn btn-secondary" onclick="closeModals()">Fechar</button>
        </div>
    </div>
</div>

<datalist id="stdContasDataList"></datalist>

<div id="modalLinkDetalhe" class="dre-modal-overlay">
    <div class="dre-modal-box">
        <h3 class="text-lg font-bold text-success mb-3">Vincular Conta (Virtual)</h3>
        <p class="text-sm text-secondary mb-3">Para Estrutura Virtual. Permite renomear.</p>
        <p class="text-sm text-secondary">Destino: <strong id="lblDetailTarget" class="text-white">...</strong></p>
        <label class="text-xs text-secondary uppercase font-bold">1. Conta Real</label>
        <input type="text" id="inputDetailConta" list="contasDataList" class="custom-input mb-3" placeholder="6010..." autocomplete="off">
        <label class="text-xs text-secondary uppercase font-bold">2. Nome na DRE (Opcional)</label>
        <input type="text" id="inputDetailName" class="custom-input" placeholder="Ex: Venda Matriz" autocomplete="off">
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeModals()">Cancelar</button>
            <button class="btn btn-success" onclick="submitLinkDetalhe()">Salvar</button>
        </div>
    </div>
</div>

<div id="modalReplicar" class="dre-modal-overlay">
    <div class="dre-modal-box" style="width: 600px;">
        <h3 class="text-lg font-bold text-primary mb-3">Replicar Estrutura</h3>
        <p class="text-sm text-secondary mb-3">Copiar de: <strong id="lblOrigemReplicar" class="text-white">...</strong></p>
        <div id="listaDestinos" style="height: 300px; overflow-y: auto; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 6px;"></div>
        <div class="d-flex justify-content-between mt-2">
            <button class="btn btn-sm btn-link text-secondary" onclick="toggleAllDestinos()" style="text-decoration:none">Inverter Seleção</button>
            <span id="lblTotalSelecionados" class="text-xs text-muted pt-2">0 selecionados</span>
        </div>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeModals()">Cancelar</button>
            <button class="btn btn-primary" onclick="submitReplicar()">Replicar Agora</button>
        </div>
    </div>
</div>

<datalist id="contasDataList"></datalist>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='JS/DreOrdenamento.js') }}"></script>
<script>
    
    let globalTodasContas = [];
    let contextNode = { id: null, type: null, text: null, ordem: null };
    let clipboard = null;
    let currentSelectedGroup = null;
    let ordenamentoAtivo = false;

document.addEventListener('DOMContentLoaded', async () => {
        // 1. Carrega as listas de contas (independente)
        loadContasList();
        
        // 2. PRIMEIRO verifica se o ordenamento está ativo
        // O await garante que o código pare aqui até o servidor responder
        await verificarOrdenamento(); 
        
        // 3. SÓ AGORA carrega a árvore, já sabendo o estado correto do ordenamento
        loadTree(); 
        
        // Event listeners globais
        document.addEventListener('click', () => document.getElementById('contextMenu').style.display = 'none');
        document.querySelectorAll('.dre-modal-overlay').forEach(o => o.addEventListener('click', e => { if(e.target === o) closeModals(); }));
        
        // Atalhos de teclado
        document.addEventListener('keydown', (e) => {
            if (!contextNode.id) return;
            
            if (e.altKey && e.key === 'ArrowUp') {
                e.preventDefault();
                moverParaCima();
            } else if (e.altKey && e.key === 'ArrowDown') {
                e.preventDefault();
                moverParaBaixo();
            }
        });
        
        document.addEventListener('click', () => document.getElementById('contextMenu').style.display = 'none');
        document.querySelectorAll('.dre-modal-overlay').forEach(o => o.addEventListener('click', e => { if(e.target === o) closeModals(); }));
        
        // Atalhos de teclado para reordenação
        document.addEventListener('keydown', (e) => {
            if (!contextNode.id) return;
            
            if (e.altKey && e.key === 'ArrowUp') {
                e.preventDefault();
                moverParaCima();
            } else if (e.altKey && e.key === 'ArrowDown') {
                e.preventDefault();
                moverParaBaixo();
            }
        });
    });

    // --- VERIFICAÇÃO E CONTROLE DE ORDENAMENTO ---
    async function verificarOrdenamento() {
        const toolbar = document.getElementById('ordenamentoToolbar');
        const indicator = document.getElementById('ordenamentoIndicator');
        const statusText = document.getElementById('ordenamentoStatusText');
        const btnInit = document.getElementById('btnInicializarOrdem');
        const btnReset = document.getElementById('btnResetarOrdem');
        const btnNorm = document.getElementById('btnNormalizarOrdem');
        
        try {
            const r = await fetch('/Ordenamento/GetFilhosOrdenados', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contexto_pai: 'root' })
            });
            
            if (r.ok) {
                const data = await r.json();
                ordenamentoAtivo = data.length > 0;
                
                if (ordenamentoAtivo) {
                    toolbar.classList.remove('inactive');
                    indicator.classList.add('active');
                    indicator.classList.remove('inactive');
                    statusText.innerHTML = '<strong class="text-success">Ordenamento Ativo</strong> - Arraste para reordenar';
                    btnInit.style.display = 'none';
                    btnReset.style.display = 'inline-block';
                    btnNorm.style.display = 'inline-block';
                } else {
                    toolbar.classList.add('inactive');
                    indicator.classList.remove('active');
                    indicator.classList.add('inactive');
                    statusText.innerHTML = '<strong class="text-warning">Ordenamento Inativo</strong> - Clique para ativar';
                    btnInit.style.display = 'inline-block';
                    btnReset.style.display = 'none';
                    btnNorm.style.display = 'none';
                }
            }
        } catch (e) {
            console.warn('Ordenamento não disponível:', e);
            toolbar.classList.add('inactive');
            statusText.innerHTML = '<span class="text-danger">API de ordenamento não encontrada</span>';
        }
    }

    async function inicializarOrdenamento() {
        if (!confirm('Isso irá criar a estrutura de ordenamento baseada na configuração atual. Continuar?')) return;
        
        try {
            showToast('Inicializando ordenamento...');
            const r = await fetch('/Ordenamento/Inicializar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ limpar: false })
            });
            
            const data = await r.json();
            if (r.ok) {
                showToast(data.msg || 'Ordenamento inicializado!');
                verificarOrdenamento();
                loadTree();
            } else {
                alert('Erro: ' + data.error);
            }
        } catch (e) {
            alert('Erro de conexão');
        }
    }

    async function resetarOrdenamento() {
        if (!confirm('ATENÇÃO: Isso irá RESETAR toda a ordem para o padrão. Continuar?')) return;
        
        try {
            const r = await fetch('/Ordenamento/Inicializar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ limpar: true })
            });
            
            if (r.ok) {
                showToast('Ordenamento resetado!');
                loadTree();
            }
        } catch (e) {
            alert('Erro');
        }
    }

    async function normalizarOrdenamento() {
        try {
            const r = await fetch('/Ordenamento/Normalizar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contexto_pai: 'root' })
            });
            
            if (r.ok) {
                showToast('Ordem normalizada!');
            }
        } catch (e) {
            console.error(e);
        }
    }

    // --- FUNÇÕES DE MOVER (UP/DOWN) ---
    async function moverParaCima() {
        if (!contextNode.id) return;
        await moverElemento(-1);
    }

    async function moverParaBaixo() {
        if (!contextNode.id) return;
        await moverElemento(1);
    }

    async function moverElemento(direcao) {
        // Pega o elemento visual atual
        const wrapper = document.querySelector(`.node-wrapper[data-id="${contextNode.id}"]`);
        if (!wrapper) return;
        
        const li = wrapper.closest('li');
        const ul = li.parentElement;
        const irmãos = Array.from(ul.querySelectorAll(':scope > li'));
        const indiceAtual = irmãos.indexOf(li);
        
        const novoIndice = indiceAtual + direcao;
        if (novoIndice < 0 || novoIndice >= irmãos.length) {
            showToast('Não é possível mover nesta direção');
            return;
        }
        
        // Move visualmente
        if (direcao < 0) {
            ul.insertBefore(li, irmãos[novoIndice]);
        } else {
            ul.insertBefore(li, irmãos[novoIndice].nextSibling);
        }
        
        // Animação
        wrapper.classList.add('just-reordered');
        setTimeout(() => wrapper.classList.remove('just-reordered'), 500);
        
        // Salva nova ordem
        await salvarOrdemContexto(ul);
        showToast('Posição atualizada!');
    }

    async function salvarOrdemContexto(ul) {
        const items = ul.querySelectorAll(':scope > li > .node-wrapper');
        const novaOrdem = [];
        
        items.forEach((item, index) => {
            const id = item.getAttribute('data-id');
            const tipo = getNodeTypeFromId(id);
            
            novaOrdem.push({
                tipo_no: tipo,
                id_referencia: extrairIdReferencia(id, tipo),
                ordem: (index + 1) * 10
            });
        });
        
        // Determina contexto pai
        const liPai = ul.parentElement;
        let contexto = 'root';
        
        if (liPai && liPai.tagName === 'LI') {
            const wrapperPai = liPai.querySelector(':scope > .node-wrapper');
            if (wrapperPai) {
                const idPai = wrapperPai.getAttribute('data-id');
                contexto = idPai;
            }
        }
        
        try {
            await fetch('/Ordenamento/ReordenarLote', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contexto_pai: contexto,
                    nova_ordem: novaOrdem
                })
            });
        } catch (e) {
            console.error('Erro ao salvar ordem:', e);
        }
    }

    function getNodeTypeFromId(id) {
        if (id.startsWith('tipo_')) return 'tipo_cc';
        if (id.startsWith('virt_')) return 'virtual';
        if (id.startsWith('cc_')) return 'cc';
        if (id.startsWith('sg_')) return 'subgrupo';
        if (id.startsWith('conta_')) return 'conta';
        if (id.startsWith('cd_')) return 'conta_detalhe';
        return 'unknown';
    }

    function extrairIdReferencia(nodeId, tipo) {
        if (tipo === 'tipo_cc') return nodeId.replace('tipo_', '');
        if (tipo === 'virtual') return nodeId.replace('virt_', '');
        if (tipo === 'cc') return nodeId.replace('cc_', '');
        if (tipo === 'subgrupo') return nodeId.replace('sg_', '');
        if (tipo === 'conta') return nodeId.replace('conta_', '');
        if (tipo === 'conta_detalhe') return nodeId.replace('cd_', '');
        return nodeId;
    }

    // --- RENDERIZAÇÃO DA ÁRVORE (COM SUPORTE A ORDENAMENTO) ---
    async function loadTree() {
        const rootUl = document.getElementById('treeRoot');
        
        try {
            // Tenta usar a API ordenada primeiro
            let response;
            let useOrdenada = false;
            
            if (ordenamentoAtivo) {
                try {
                    response = await fetch('/Ordenamento/GetArvoreOrdenada');
                    if (response.ok) {
                        useOrdenada = true;
                    }
                } catch (e) {
                    console.warn('API ordenada não disponível, usando padrão');
                }
            }
            
            if (!useOrdenada) {
                response = await fetch('/Configuracao/GetDadosArvore');
            }
            
            const data = await response.json();
            rootUl.innerHTML = '';
            
            if (!data || data.length === 0) { 
                rootUl.innerHTML = '<li class="text-secondary p-4 text-center">Nenhuma estrutura encontrada.<br>Comece criando um Nó Virtual ou importe do ERP.</li>'; 
                return; 
            }
            
            data.forEach(item => rootUl.appendChild(createNodeHTML(item)));
            
            // Habilita drag-drop se ordenamento ativo
            if (ordenamentoAtivo && window.dreOrdenamento) {
                setTimeout(() => window.dreOrdenamento.habilitarDragDrop(), 200);
            }
            
        } catch (error) { 
            console.error(error); 
            rootUl.innerHTML = '<li class="text-danger p-4">Erro ao carregar dados.</li>'; 
        }
    }

    function createNodeHTML(node) {
        const li = document.createElement('li');
        const wrapper = document.createElement('div');
        
        let typeClass = 'node-std';
        let icon = 'fa-circle';
        
        if(node.type === 'root_tipo') { typeClass = 'node-folder'; icon = 'fa-folder'; }
        else if(node.type === 'root_cc') { typeClass = 'node-cc'; icon = 'fa-building'; }
        else if(node.type === 'root_virtual') { typeClass = 'node-virtual'; icon = 'fa-layer-group'; }
        else if(node.type === 'subgrupo') { typeClass = 'node-sg'; icon = 'fa-folder-open'; }
        else if(node.type.includes('conta')) { typeClass = 'node-conta'; icon = 'fa-file-invoice'; }

        wrapper.className = `node-wrapper ${typeClass}`;
        wrapper.setAttribute('data-id', node.id);
        if (node.ordem) wrapper.setAttribute('data-ordem', node.ordem);
        
        const hasChildren = node.children && node.children.length > 0;
        
        // Drag Handle (só aparece se ordenamento ativo)
        let dragHandleHtml = '';
        if (ordenamentoAtivo) {
            dragHandleHtml = '<i class="fas fa-grip-vertical drag-handle"></i>';
        }
        
        const toggle = document.createElement('div');
        toggle.className = `toggle-icon ${hasChildren ? '' : 'invisible'}`;
        toggle.innerHTML = '<i class="fas fa-chevron-right"></i>';
        
        if(hasChildren) {
            toggle.onclick = (e) => {
                e.stopPropagation();
                toggleNode(li, toggle);
            };
            wrapper.ondblclick = (e) => {
                e.stopPropagation();
                toggleNode(li, toggle);
            };
        }

        // Badge de ordem (debug/visual)
        let ordemBadge = '';
        if (node.ordem && ordenamentoAtivo) {
            ordemBadge = `<span class="ordem-badge" title="Ordem: ${node.ordem}">#${node.ordem}</span>`;
        }

        const contentHtml = `
            ${dragHandleHtml}
            <i class="fas ${icon} type-icon"></i>
            <span class="node-text">${node.text}</span>
            ${ordemBadge}
        `;
        
        const contentSpan = document.createElement('span');
        contentSpan.innerHTML = contentHtml;
        contentSpan.style.display = 'flex';
        contentSpan.style.alignItems = 'center';
        contentSpan.style.flex = '1';

        wrapper.appendChild(toggle);
        wrapper.appendChild(contentSpan);
        
        wrapper.onclick = () => selectNodeUI(wrapper);
        wrapper.oncontextmenu = (e) => handleRightClick(e, node, wrapper);

        li.appendChild(wrapper);

        if (hasChildren) {
            const ul = document.createElement('ul');
            
            // Expande automaticamente os tipos e virtuais na carga inicial

            if (node.type === 'root_tipo' || node.type === 'root_virtual') {
                ul.classList.add('expanded');
                toggle.classList.add('rotated');
            }

            // ------------------------------------

            node.children.forEach(child => ul.appendChild(createNodeHTML(child)));
            li.appendChild(ul);
        }

        return li;
    }

    function toggleNode(li, toggleIcon) {
        const ul = li.querySelector('ul');
        if (ul) {
            ul.classList.toggle('expanded');
            toggleIcon.classList.toggle('rotated');
        }
    }

    function toggleAllTree(expand) {
        const uls = document.querySelectorAll('#treeRoot ul');
        const toggles = document.querySelectorAll('.toggle-icon:not(.invisible)');
        
        uls.forEach(ul => expand ? ul.classList.add('expanded') : ul.classList.remove('expanded'));
        toggles.forEach(t => expand ? t.classList.add('rotated') : t.classList.remove('rotated'));
    }

    function selectNodeUI(element) {
        document.querySelectorAll('.node-wrapper').forEach(el => el.classList.remove('selected'));
        element.classList.add('selected');
    }

    // --- MENU DE CONTEXTO ---
    function handleRightClick(e, node, element) {
        e.preventDefault();
        selectNodeUI(element);
        contextNode = node;
        
        const menu = document.getElementById('contextMenu');
        
        // Esconde tudo primeiro
        const els = ['ctxRename', /* ... seus outros IDs ... */]; 
        els.forEach(id => { 
            const el = document.getElementById(id); 
            if(el) el.style.display = 'none'; 
        });

        const show = (id) => { const el = document.getElementById(id); if(el) el.style.display = 'flex'; };

        // Lógica de exibição do Renomear
        if (node.type === 'root_virtual' || node.type === 'subgrupo' || node.type === 'conta_detalhe') {
            show('ctxRename');
        }
        const showDiv = (id) => { const el = document.getElementById(id); if(el) el.style.display = 'block'; };

        // Opções de ordenamento (sempre mostrar se ativo)
        if (ordenamentoAtivo) {
            show('ctxMoveUp');
            show('ctxMoveDown');
            showDiv('divOrdem');
        }

        if (node.type === 'root_tipo') {
            show('ctxMassManager'); 
            showDiv('divSystematic');
        }
        else if (node.type === 'root_cc') {
            show('ctxAddSub');
            show('ctxReplicar');
            if(clipboard) show('ctxPaste');
        } 
        else if (node.type === 'subgrupo') {
            show('ctxAddSub');
            show('ctxCopy');
            if(clipboard) show('ctxPaste');
            showDiv('divCopy');
            show('ctxLinkConta');
            show('ctxLinkDetalhe');
            showDiv('ctxDivider');
            show('ctxDelete');
        }
        else if (node.type === 'root_virtual') {
            show('ctxAddSub');
            if(clipboard) show('ctxPaste');
            show('ctxLinkDetalhe');
            showDiv('ctxDivider');
            show('ctxDelete');
        }
        else if (node.type.includes('conta')) {
            show('ctxDelete');
        }

        const clickX = e.clientX;
        const clickY = e.clientY;
        menu.style.left = `${e.clientX}px`;
        menu.style.top = `${e.clientY}px`;
        menu.style.display = 'block';
    }

    // 2. NOVA FUNÇÃO PARA EXECUTAR O RENOMEAR
    async function renameNode() {
        // Usa um prompt simples do navegador (pode trocar por modal se quiser mais elegância)
        const novoNome = prompt("Novo nome para: " + contextNode.text, contextNode.text);
        
        if (!novoNome || novoNome === contextNode.text) return;

        let url = '';
        
        if (contextNode.type === 'root_virtual') url = '/Configuracao/RenameNoVirtual';
        else if (contextNode.type === 'subgrupo') url = '/Configuracao/RenameSubgrupo';
        else if (contextNode.type === 'conta_detalhe') url = '/Configuracao/RenameContaPersonalizada';
        
        if (!url) return alert('Este item não pode ser renomeado.');

        try {
            const r = await fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id: contextNode.id, novo_nome: novoNome })
            });
            
            if (r.ok) {
                showToast('Renomeado com sucesso!');
                loadTree(); // Recarrega a árvore para mostrar o novo nome
            } else {
                const d = await r.json();
                alert('Erro: ' + d.error);
            }
        } catch (e) {
            console.error(e);
            alert('Erro de conexão ao renomear.');
        }
        
        document.getElementById('contextMenu').style.display = 'none';
    }

    function copyNode() {
        if (!contextNode.id.startsWith('sg_')) return alert('Apenas subgrupos podem ser copiados.');
        clipboard = { id: contextNode.id, text: contextNode.text };
        showToast(`Copiado: ${contextNode.text}`);
        document.getElementById('contextMenu').style.display = 'none';
    }

    async function pasteNode() {
        if (!clipboard) return;
        if (!confirm(`Colar "${clipboard.text}" dentro de "${contextNode.text}"?`)) return;
        fetchAPI('/Configuracao/ColarEstrutura', { origem_id: clipboard.id, destino_id: contextNode.id }, 'Estrutura colada!');
    }

    async function openReplicarModal() {
        openModal('modalReplicar');
        document.getElementById('lblOrigemReplicar').innerText = contextNode.text;
        const list = document.getElementById('listaDestinos');
        list.innerHTML = '<div class="text-center p-3">Carregando...</div>';
        
        try {
            const res = await fetch('/Configuracao/GetDadosArvore');
            const data = await res.json();
            let targets = [];
            
            data.forEach(root => {
                if(root.type === 'root_tipo' && root.id !== 'root_virtual_group') {
                    if(root.children) {
                        root.children.forEach(cc => {
                            if(cc.id !== contextNode.id) {
                                targets.push({ id: cc.id.replace('cc_', ''), text: cc.text, group: root.text });
                            }
                        });
                    }
                }
            });

            let html = '';
            let lastGroup = '';
            targets.forEach(t => {
                if(t.group !== lastGroup) {
                    html += `<div class="text-xs font-bold text-primary mt-2 mb-1 border-bottom border-secondary p-1 sticky-top" style="background:#1e2736">${t.group}</div>`;
                    lastGroup = t.group;
                }
                html += `
                    <div class="d-flex align-items-center gap-2 py-1 px-2 hover-bg">
                        <input type="checkbox" class="chk-dest" value="${t.id}">
                        <span class="text-sm">${t.text}</span>
                    </div>
                `;
            });
            list.innerHTML = html;
        } catch(e) { list.innerHTML = 'Erro ao carregar lista.'; }
    }

    function toggleAllDestinos() {
        const chks = document.querySelectorAll('.chk-dest');
        chks.forEach(c => c.checked = !c.checked);
        const count = document.querySelectorAll('.chk-dest:checked').length;
        document.getElementById('lblTotalSelecionados').innerText = `${count} selecionados`;
    }

    async function submitReplicar() {
        const ids = Array.from(document.querySelectorAll('.chk-dest:checked')).map(c => c.value);
        if(ids.length === 0) return alert("Selecione destinos.");
        if(!confirm(`Replicar para ${ids.length} locais?`)) return;
        fetchAPI('/Configuracao/ReplicarEstrutura', { origem_node_id: contextNode.id, destinos_ids: ids }, 'Replicação concluída!');
    }

    function openMassManager() {
        const tipoCC = contextNode.id.replace('tipo_', '');
        document.getElementById('lblMassType').innerText = tipoCC;
        loadMassGroupsList(tipoCC);
        document.getElementById('inputMassCreateName').value = '';
        document.getElementById('inputMassLinkConta').value = '';
        document.getElementById('inputMassUnlinkConta').value = '';
        openModal('modalMassManager');
        switchMassTab('tabCreateGroup', document.querySelector('.mass-nav-item')); 
    }

    function switchMassTab(tabId, navElement) {
        document.querySelectorAll('.mass-tab').forEach(t => t.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.querySelectorAll('.mass-nav-item').forEach(n => n.classList.remove('active'));
        if(navElement) navElement.classList.add('active');
    }

    async function loadMassGroupsList(tipoCC) {
        const listContainer = document.getElementById('listMassGroups');
        listContainer.innerHTML = '<div class="text-center p-3 text-secondary"><i class="fas fa-spinner fa-spin"></i></div>';
        
        document.getElementById('noGroupSelected').style.display = 'flex';
        document.getElementById('groupDetails').style.display = 'none';
        currentSelectedGroup = null;

        const selDel = document.getElementById('selectMassDeleteGroup');
        selDel.innerHTML = '<option>Carregando...</option>';

        try {
            const r = await fetch('/Configuracao/GetSubgruposPorTipo', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ tipo_cc: tipoCC })
            });
            const grupos = await r.json();

            let htmlList = '';
            let htmlSelect = '<option value="" disabled selected>Selecione...</option>';

            if(grupos.length > 0) {
                grupos.forEach(g => {
                    htmlList += `
                        <div class="group-list-item" onclick="selectMassGroup('${g}', this)">
                            <span><i class="fas fa-folder text-warning me-2"></i> ${g}</span>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    `;
                    htmlSelect += `<option value="${g}">${g}</option>`;
                });
            } else {
                htmlList = '<div class="p-3 text-muted text-center text-sm">Nenhum grupo criado.</div>';
                htmlSelect = '<option disabled>Vazio</option>';
            }
            
            listContainer.innerHTML = htmlList;
            selDel.innerHTML = htmlSelect;

        } catch(e) { console.error(e); }
    }

    async function selectMassGroup(groupName, element) {
        currentSelectedGroup = groupName;
        const tipoCC = document.getElementById('lblMassType').innerText;

        document.querySelectorAll('.group-list-item').forEach(i => i.classList.remove('active'));
        element.classList.add('active');
        
        document.getElementById('noGroupSelected').style.display = 'none';
        document.getElementById('groupDetails').style.display = 'flex';
        document.getElementById('lblSelectedGroup').innerText = groupName;
        document.getElementById('inputMassLinkConta').value = ''; 

        const areaContas = document.getElementById('listLinkedAccounts');
        areaContas.innerHTML = '<div class="text-secondary w-100 text-center mt-4"><i class="fas fa-spinner fa-spin"></i></div>';

        try {
            const r = await fetch('/Configuracao/GetContasDoGrupoMassa', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ tipo_cc: tipoCC, nome_grupo: groupName })
            });
            const contasVinculadas = await r.json(); 
            
            document.getElementById('lblCountAccounts').innerText = `${contasVinculadas.length} contas`;
            updateMassDatalist(contasVinculadas);

            if(contasVinculadas.length === 0) {
                areaContas.innerHTML = '<div class="empty-state">Nenhuma conta vinculada ainda.</div>';
            } else {
                let tags = '';
                contasVinculadas.forEach(c => {
                    const contaInfo = globalTodasContas.find(x => x.numero == c);
                    const labelConta = contaInfo ? `${c} - ${contaInfo.nome.substring(0, 15)}...` : c;

                    tags += `
                        <div class="account-tag">
                            ${labelConta}
                            <i class="fas fa-times remove-btn" onclick="removeAccountFromGroup('${c}')" title="Desvincular"></i>
                        </div>
                    `;
                });
                areaContas.innerHTML = tags;
            }
        } catch(e) { 
            console.error(e);
            areaContas.innerHTML = '<div class="text-danger">Erro ao carregar.</div>'; 
        }
    }

    async function submitMassCreate() {
        const nome = document.getElementById('inputMassCreateName').value;
        const tipoCC = document.getElementById('lblMassType').innerText;
        if(!nome) return alert('Nome obrigatório.');
        fetchAPI('/Configuracao/AddSubgrupoSistematico', { nome: nome, tipo_cc: tipoCC });
    }

    async function submitMassDelete() {
        const nome = document.getElementById('selectMassDeleteGroup').value;
        const tipoCC = document.getElementById('lblMassType').innerText;
        if(!nome) return alert('Selecione um grupo.');
        if(!confirm(`ATENÇÃO: Isso excluirá o grupo "${nome}" de TODOS os CCs de ${tipoCC}. Continuar?`)) return;
        fetchAPI('/Configuracao/DeleteSubgrupoEmMassa', { nome_grupo: nome, tipo_cc: tipoCC });
    }

    async function submitMassUnlink() {
        const conta = document.getElementById('inputMassUnlinkConta').value;
        const tipoCC = document.getElementById('lblMassType').innerText;
        if(!conta) return alert('Digite a conta.');
        if(!confirm(`Remover o vínculo da conta ${conta} de todos os CCs?`)) return;
        fetchAPI('/Configuracao/DesvincularContaEmMassa', { tipo_cc: tipoCC, conta: conta });
    }

    async function addAccountToGroup() {
        if(!currentSelectedGroup) return;
        const conta = document.getElementById('inputMassLinkConta').value;
        const tipoCC = document.getElementById('lblMassType').innerText;
        if(!conta) return alert('Digite a conta.');

        try {
            const r = await fetch('/Configuracao/VincularContaEmMassa', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ tipo_cc: tipoCC, nome_subgrupo: currentSelectedGroup, conta: conta })
            });
            if(r.ok) {
                document.getElementById('inputMassLinkConta').value = '';
                const activeItem = document.querySelector('.group-list-item.active');
                if(activeItem) selectMassGroup(currentSelectedGroup, activeItem);
                showToast(`Conta ${conta} adicionada!`);
            } else {
                const d = await r.json(); alert('Erro: ' + d.error);
            }
        } catch(e) { alert('Erro de conexão'); }
    }

    async function removeAccountFromGroup(conta) {
        if(!currentSelectedGroup) return;
        const tipoCC = document.getElementById('lblMassType').innerText;
        if(!confirm(`Remover conta ${conta} deste grupo em TODOS os CCs?`)) return;

        try {
            const r = await fetch('/Configuracao/DesvincularContaEmMassa', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ tipo_cc: tipoCC, conta: conta })
            });
            if(r.ok) {
                const activeItem = document.querySelector('.group-list-item.active');
                if(activeItem) selectMassGroup(currentSelectedGroup, activeItem);
                showToast('Conta removida.');
            }
        } catch(e) { alert('Erro ao remover'); }
    }

    function openModal(id) {
        const m = document.getElementById(id);
        document.getElementById('contextMenu').style.display = 'none';
        m.classList.add('active'); m.style.setProperty('display', 'flex', 'important');
        
        if(id==='modalAddSub') { document.getElementById('lblParentName').innerText = contextNode.text; resetInput('inputSubName'); }
        if(id==='modalLinkDetalhe') { document.getElementById('lblDetailTarget').innerText = contextNode.text; resetInput('inputDetailConta'); document.getElementById('inputDetailName').value = ''; }
        if(id==='modalAddVirtual') resetInput('inputVirtualName');

        if(id==='modalLinkConta') { 
            document.getElementById('lblGroupTarget').innerText = contextNode.text; 
            document.getElementById('inputContaSearch').value = '';
            loadStdGroupAccounts(contextNode.id);
        }
    }
    
    function resetInput(id){ const e = document.getElementById(id); if(e){ e.value=''; setTimeout(()=>e.focus(),100); } }
    function closeModals(){ document.querySelectorAll('.dre-modal-overlay').forEach(m=>{ m.classList.remove('active'); m.style.display='none'; }); }
    function showToast(msg) { const t = document.getElementById("toast"); t.innerHTML = `<i class="fas fa-check"></i> ${msg}`; t.className = "show"; setTimeout(() => t.className = "", 3000); }

    async function fetchAPI(url, body, successMsg='Sucesso!') {
        try {
            const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
            const data = await r.json();

            if(r.ok) { 
                showToast(data.msg || successMsg); 
                closeModals(); 
                loadTree(); 
            } else { 
                alert("Erro: "+ data.error); 
            }
        } catch(e) { alert("Erro de conexão."); }
        document.getElementById('contextMenu').style.display = 'none';
    }

    async function submitAddVirtual() { const n=document.getElementById('inputVirtualName').value; if(!n)return alert('Nome?'); fetchAPI('/Configuracao/AddNoVirtual', {nome:n}); }
    async function submitAddSub() { const n=document.getElementById('inputSubName').value; if(!n)return alert('Nome?'); fetchAPI('/Configuracao/AddSubgrupo', {nome:n, parent_id:contextNode.id}); }
    
    async function submitLinkConta() { 
        const c = document.getElementById('inputContaSearch').value; 
        if(!c) return alert('Conta?'); 
        try {
            const r = await fetch('/Configuracao/VincularConta', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ conta: c, subgrupo_id: contextNode.id })
            });
            if(r.ok) {
                showToast('Conta vinculada!');
                document.getElementById('inputContaSearch').value = '';
                loadStdGroupAccounts(contextNode.id);
                loadTree();
            } else {
                const d = await r.json(); alert(d.error);
            }
        } catch(e) { alert("Erro de conexão"); }
    }

    async function submitLinkDetalhe() { const c=document.getElementById('inputDetailConta').value; const n=document.getElementById('inputDetailName').value; if(!c)return alert('Conta?'); fetchAPI('/Configuracao/VincularContaDetalhe', {conta:c, nome_personalizado:n, parent_id:contextNode.id}); }
    
    async function deleteNode() {
        if(!confirm(`Remover "${contextNode.text}"?`)) return;
        let url = '';
        if(contextNode.type==='subgrupo') url='/Configuracao/DeleteSubgrupo';
        if(contextNode.type.includes('conta')) url='/Configuracao/DesvincularConta';
        if(contextNode.type==='root_virtual') url='/Configuracao/DeleteNoVirtual';
        if(!url) return;
        fetchAPI(url, {id:contextNode.id}, 'Item removido.');
    }

    async function loadContasList() {
        try {
            const r = await fetch('/Configuracao/GetContasDisponiveis');
            const d = await r.json();
            
            globalTodasContas = d; 

            const dl = document.getElementById('contasDataList'); 
            dl.innerHTML = '';
            d.forEach(c => { 
                const o = document.createElement('option'); 
                o.value = c.numero; 
                o.label = c.nome; 
                dl.appendChild(o); 
            });
        } catch(e){}
    }

    function updateMassDatalist(contasJaVinculadas) {
        const dlMass = document.getElementById('massContasDataList');
        dlMass.innerHTML = ''; 
        const contasFiltradas = globalTodasContas.filter(c => !contasJaVinculadas.includes(c.numero.toString()));
        contasFiltradas.forEach(c => {
            const o = document.createElement('option');
            o.value = c.numero;
            o.label = c.nome;
            dlMass.appendChild(o);
        });
    }

    async function loadStdGroupAccounts(nodeId) {
        const areaContas = document.getElementById('listStdLinkedAccounts');
        areaContas.innerHTML = '<div class="text-center text-secondary pt-4"><i class="fas fa-spinner fa-spin"></i></div>';
        
        const dbId = nodeId.replace('sg_', ''); 

        try {
            const r = await fetch('/Configuracao/GetContasDoSubgrupo', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id: dbId })
            });
            
            const data = await r.json();

            if (!r.ok || !Array.isArray(data)) {
                console.error("Erro servidor:", data);
                areaContas.innerHTML = '<div class="text-danger text-center pt-4 text-sm">Erro ao buscar contas.</div>';
                document.getElementById('lblCountStd').innerText = "0";
                return;
            }

            const contasVinculadas = data;

            document.getElementById('lblCountStd').innerText = contasVinculadas.length;
            updateStdDatalist(contasVinculadas);

            if(contasVinculadas.length === 0) {
                areaContas.innerHTML = '<div class="text-center text-secondary pt-4 text-sm">Nenhuma conta vinculada.</div>';
            } else {
                let tags = '';
                contasVinculadas.forEach(c => {
                    const contaInfo = globalTodasContas.find(x => x.numero == c);
                    const labelConta = contaInfo ? `${c} - ${contaInfo.nome.substring(0, 15)}...` : c;

                    tags += `
                        <div class="account-tag">
                            ${labelConta}
                            <i class="fas fa-times remove-btn" onclick="removeStdAccount('${c}')" title="Desvincular"></i>
                        </div>
                    `;
                });
                areaContas.innerHTML = tags;
            }

        } catch(e) { 
            console.error(e);
            areaContas.innerHTML = '<div class="text-danger text-center pt-4">Erro de conexão.</div>';
        }
    }

    function updateStdDatalist(contasJaVinculadas) {
        const dl = document.getElementById('stdContasDataList');
        dl.innerHTML = ''; 
        const disponiveis = globalTodasContas.filter(c => !contasJaVinculadas.includes(c.numero.toString()));
        disponiveis.forEach(c => {
            const o = document.createElement('option');
            o.value = c.numero;
            o.label = c.nome;
            dl.appendChild(o);
        });
    }

    async function removeStdAccount(conta) {
        if(!confirm(`Desvincular a conta ${conta}?`)) return;
        try {
            const nodeFakeId = `conta_${conta}`;
            const r = await fetch('/Configuracao/DesvincularConta', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id: nodeFakeId })
            });
            if(r.ok) {
                showToast('Desvinculado.');
                loadStdGroupAccounts(contextNode.id);
                loadTree();
            }
        } catch(e) { alert("Erro ao remover"); }
    }

    // ADICIONE NO FINAL DO SCRIPT
    async function sincronizarOrdem() {
        const btn = event.currentTarget;
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
        btn.disabled = true;

        try {
            // Chama a rota Inicializar com limpar=false (apenas adiciona novos)
            const r = await fetch('/Ordenamento/Inicializar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ limpar: false })
            });
            
            if (r.ok) {
                const data = await r.json();
                showToast(data.msg || 'Sincronização concluída!');
                loadTree(); // Recarrega a árvore para mostrar os novos itens
            } else {
                alert('Erro na sincronização');
            }
        } catch (e) {
            console.error(e);
            alert('Erro de conexão');
        } finally {
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        }
    }

</script>
{% endblock %}