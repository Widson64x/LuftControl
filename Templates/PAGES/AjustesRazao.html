{% extends "Base.html" %}

{% block title %}Ajustes Cont√°beis - T-Controllership{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='CSS/Reports.css') }}">
    <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='CSS/Pages/AjustesRazao.css') }}">
{% endblock %}

{% block content %}
<div class="page-header fade-in">
    <div class="header-decoration decoration-1"></div>
    <div class="header-decoration decoration-2"></div>
    
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title">
                <i class="fas fa-balance-scale"></i> Ajustes & Espelho Raz√£o
            </h1>
            <p class="page-subtitle">Gest√£o completa de lan√ßamentos e fluxo de aprova√ß√£o.</p>
        </div>
        <div class="header-actions">
            <button class="btn-secondary-custom" onclick="ajustesSystem.toggleFilterPanel()">
                <i class="fas fa-filter"></i> Filtros Avan√ßados
            </button>
            <button class="btn-primary-custom" onclick="ajustesSystem.openModalInclusao()">
                <i class="fas fa-plus-circle"></i> Novo Lan√ßamento
            </button>
            <button class="btn-secondary-custom" onclick="ajustesSystem.loadData()">
                <i class="fas fa-sync-alt"></i> Atualizar
            </button>
        </div>
    </div>
</div>

<div id="filterBackdrop" class="filter-backdrop" onclick="ajustesSystem.toggleFilterPanel()"></div>

<div id="advancedFilterPanel" class="filter-panel-wrapper">
    <div class="filter-header">
        <h3><i class="fas fa-sliders-h"></i> Controle & Filtragem</h3>
        <button class="btn-text" onclick="ajustesSystem.toggleFilterPanel()" title="Fechar" style="font-size: 1.2rem;">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <div class="filter-body-grid">
        
        <div class="filter-section">
            <h5 class="section-title">üìÖ Per√≠odo & Compet√™ncia</h5>
            <div class="row-inputs">
                <div class="input-group">
                    <label>M√™s</label>
                    <select id="fMes" class="modern-input">
                        <option value="">Todos</option>
                        <option value="1">Janeiro</option>
                        <option value="2">Fevereiro</option>
                        <option value="3">Mar√ßo</option>
                        <option value="4">Abril</option>
                        <option value="5">Maio</option>
                        <option value="6">Junho</option>
                        <option value="7">Julho</option>
                        <option value="8">Agosto</option>
                        <option value="9">Setembro</option>
                        <option value="10">Outubro</option>
                        <option value="11">Novembro</option>
                        <option value="12">Dezembro</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Ano</label>
                    <input type="number" id="fAno" class="modern-input" placeholder="Ex: 2025">
                </div>
            </div>
            
            <div class="row-inputs mt-2">
                <div class="input-group full">
                    <label>Intervalo Espec√≠fico (Opcional)</label>
                    <div class="date-range-group">
                        <input type="date" id="fDataIni" class="modern-input">
                        <span class="range-separator">at√©</span>
                        <input type="date" id="fDataFim" class="modern-input">
                    </div>
                </div>
            </div>
        </div>

        <div class="filter-section">
            <h5 class="section-title">üìÇ Categoriza√ß√£o</h5>
            
            <div class="input-group">
                <div class="d-flex justify-content-between align-items-center">
                    <label>Status</label>
                    <small style="font-size: 0.75em; color: var(--primary); cursor: pointer; text-decoration: underline;" 
                           onclick="document.getElementById('fStatus').selectedIndex = -1">
                        Limpar sele√ß√£o
                    </small>
                </div>
                <select id="fStatus" class="modern-input" multiple size="4" style="overflow-y: hidden;">
                    <option value="Pendente">Pendente</option>
                    <option value="Aprovado">Aprovado</option>
                    <option value="Reprovado">Reprovado</option>
                    <option value="Invalido">Inv√°lido</option>
                </select>
                <small style="font-size:10px; color: #666; margin-top: 4px; display: block;">
                    * Segure CTRL para selecionar v√°rios. Se nenhum for selecionado, busca todos.
                </small>
            </div>

            <div class="input-group mt-2">
                <label>Origem</label>
                <select id="fOrigem" class="modern-input">
                    <option value="">Todas</option>
                    <option value="FARMA">Farma</option>
                    <option value="FARMADIST">Farma Dist</option>
                    <option value="INTEC">Intec</option>
                    <option value="MANUAL">Manual</option>
                </select>
            </div>
        </div>

        <div class="filter-section">
            <h5 class="section-title">üîç Busca & Valores</h5>
            <div class="input-group">
                <label>Busca Global</label>
                <input type="text" id="fBuscaGlobal" class="modern-input" placeholder="Conta, Descri√ß√£o, Hist√≥rico...">
            </div>
            <div class="input-group mt-2">
                <label>Valor M√≠nimo (Saldo)</label>
                <input type="number" id="fValorMin" class="modern-input" placeholder="0,00">
            </div>
        </div>
        
        <div class="filter-section">
            <h5 class="section-title">‚ö° Ordenar Por</h5>
            <div class="sort-buttons">
                <button class="btn-sort" onclick="ajustesSystem.quickSort('Data', 'desc')">üìÖ Data Recente</button>
                <button class="btn-sort" onclick="ajustesSystem.quickSort('Data', 'asc')">üìÖ Data Antiga</button>
                <button class="btn-sort" onclick="ajustesSystem.quickSort('Saldo', 'desc')">üí∞ Maior Valor</button>
            </div>
        </div>
    </div>

    <div class="filter-footer">
        <div style="display: flex; gap: 10px;">
            <button class="btn-secondary-custom" style="flex: 1;" onclick="ajustesSystem.clearFilters()">
                <i class="fas fa-eraser"></i> Limpar Tudo
            </button>
            <button class="btn-primary-custom" style="flex: 1;" onclick="ajustesSystem.applyAdvancedFilters()">
                <i class="fas fa-filter"></i> Aplicar Filtros
            </button>
        </div>
    </div>
</div>

<div class="content-card fade-in" style="margin-top: 20px; height: calc(100vh - 280px);">
    <div id="gridAjustes" class="tabulator-custom"></div>
</div>

<div class="modal-overlay" id="modalAjuste">
    <div class="custom-modal">
        <div class="modal-header">
            <h2><i class="fas fa-edit"></i> <span id="modalTitleText">Editar Lan√ßamento</span></h2>
            <button class="modal-close" onclick="ajustesSystem.closeModal()"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body">
            <form id="formAjuste" onsubmit="event.preventDefault(); ajustesSystem.save();">
                <input type="hidden" id="inpHashId">
                <input type="hidden" id="inpAjusteId">
                <input type="hidden" id="inpTipoOperacao">
                <div class="form-grid-wrapper">
                    <div class="form-group">
                        <label>Data *</label>
                        <input type="date" id="inpData" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Origem</label>
                        <select id="inpOrigem" class="form-control">
                            <option value="FARMA">FARMA</option>
                            <option value="FARMADIST">FARMADIST</option>
                            <option value="INTEC">INTEC</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Filial</label><input type="text" id="inpFilial" class="form-control"></div>
                    <div class="form-group"><label>N√∫mero Doc.</label><input type="text" id="inpNumero" class="form-control"></div>
                    <div class="form-group"><label>Conta Cont√°bil *</label><input type="text" id="inpConta" class="form-control" required></div>
                    <div class="form-group span-2"><label>T√≠tulo da Conta</label><input type="text" id="inpTituloConta" class="form-control"></div>
                    <div class="form-group"><label>Item (Classif.)</label><input type="text" id="inpItem" class="form-control"></div>
                    <div class="form-group span-2"><label>Centro de Custo</label><input type="text" id="inpCC" class="form-control"></div>
                    <div class="form-group"><label>C√≥d. Cl. Valor</label><input type="text" id="inpCodCl" class="form-control"></div>
                    <div class="form-group"><label>Contra Partida</label><input type="text" id="inpContraPartida" class="form-control"></div>
                    <div class="form-group span-4"><label>Descri√ß√£o do Lan√ßamento *</label><input type="text" id="inpDescricao" class="form-control" required placeholder="Descreva o motivo..."></div>
                    <div class="form-group"><label class="lbl-debito">D√©bito (R$)</label><input type="number" step="0.01" id="inpDebito" class="form-control input-money"></div>
                    <div class="form-group"><label class="lbl-credito">Cr√©dito (R$)</label><input type="number" step="0.01" id="inpCredito" class="form-control input-money"></div>
                    <div class="form-group flex-center"><div class="switch-container"><label class="switch"><input type="checkbox" id="inpNaoOperacional"><span class="slider"></span></label><span class="switch-label">N√£o Operacional</span></div></div>
                    <div class="form-group flex-center"><div class="switch-container"><label class="switch"><input type="checkbox" id="inpExibirSaldo" checked><span class="slider blue"></span></label><span class="switch-label">Calcular Saldo</span></div></div>
                </div> 
                <div class="modal-footer">
                    <button type="button" class="btn-secondary-custom" onclick="ajustesSystem.closeModal()">Cancelar</button>
                    <button type="submit" class="btn-primary-custom" id="btnSalvar"><i class="fas fa-save"></i> Salvar Dados</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modalHistorico">
    <div class="custom-modal" style="width: 90%; max-width: 850px; height: 80vh; display: flex; flex-direction: column;">
        <div class="modal-header">
            <h2><i class="fas fa-history"></i> Hist√≥rico de Altera√ß√µes</h2>
            <button class="modal-close" onclick="ajustesSystem.closeHistoryModal()"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 0;">
            <table class="history-table">
                <thead><tr><th>Data/Hora</th><th>Usu√°rio</th><th>A√ß√£o</th><th>Campo</th><th>Valor Antigo</th><th>Valor Novo</th></tr></thead>
                <tbody id="tbodyHistorico"></tbody>
            </table>
        </div>
        <div class="modal-footer"><button class="btn-secondary-custom" onclick="ajustesSystem.closeHistoryModal()">Fechar</button></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
<script src="{{ url_for('static', filename='JS/AjustesRazao.js') }}"></script>
<script>
    const API_ROUTES = {
        getDados:    "{{ url_for('Ajustes.get_dados') }}",
        getIntergrupos: "{{ url_for('Ajustes.gerar_ajuste_intergrupo') }}",
        postSalvar:  "{{ url_for('Ajustes.salvar') }}",
        postAprovar: "{{ url_for('Ajustes.aprovar') }}",
        postStatusInvalido: "{{ url_for('Ajustes.alterar_status_invalido') }}",
        getHistoricoTemplate: "{{ url_for('Ajustes.get_historico', id_ajuste=0) }}"
    };
</script>
{% endblock %}